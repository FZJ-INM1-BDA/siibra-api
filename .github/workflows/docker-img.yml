name: '[docker image]'

on:
  push:
    branches:
    - v1_EOL

env:
  OKD_PROJECT: siibra-api
  OKD_DEV_ENDPOINT: https://okd-dev.hbp.eu:443
  OKD_PROD_ENDPOINT: https://okd.hbp.eu:443
  OKD_DEV_SECRET: ${{ secrets.OKD_DEV_SECRET }}
  OKD_PROD_SECRET: ${{ secrets.OKD_PROD_SECRET }}
  DOCKER_REGISTRY: 'docker-registry.ebrains.eu/siibra/'
  DOCKER_IMG: 'siibra-api'

jobs:
  build-docker-img:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: 'Set version variables'
      run: |
        VERSION=$(grep -Po '^__version__.*?"\K[\w.]+' app/__init__.py)
        echo "VERSION found: $VERSION"
        echo "VERSION=$VERSION" >> $GITHUB_ENV
    - name: 'Set DOCKER_IMAGE_TAG'
      run: |
        echo "GITHUB_REF: $GITHUB_REF"
        DOCKER_IMAGE_TAG=$VERSION

        echo "DOCKER_IMAGE_TAG: $DOCKER_IMAGE_TAG"
        echo "DOCKER_IMAGE_TAG=$DOCKER_IMAGE_TAG" >> $GITHUB_ENV

    - name: 'Build docker image'
      run: |
        DOCKER_BUILT_TAG=${{ env.DOCKER_REGISTRY }}${{ env.DOCKER_IMG }}:$DOCKER_IMAGE_TAG
        echo "Building $DOCKER_BUILT_TAG"
        docker build \
          -t $DOCKER_BUILT_TAG \
          .
        echo "Successfully built $DOCKER_BUILT_TAG"
        echo "DOCKER_BUILT_TAG=$DOCKER_BUILT_TAG" >> $GITHUB_ENV

    - name: 'Push to docker registry'
      run: |
        echo "Login to docker registry"
        docker login \
          -u '${{ secrets.EBRAINS_DOCKER_REG_USER }}' \
          -p '${{ secrets.EBRAINS_DOCKER_REG_TOKEN }}' \
          docker-registry.ebrains.eu
        echo "Pushing $DOCKER_BUILT_TAG"
        docker push $DOCKER_BUILT_TAG
