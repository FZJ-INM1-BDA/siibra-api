name: '[docker image]'

on:
  push:
    branches:
    - master
  release:
    types:
    - published

env:
  OKD_PROJECT: siibra-api
  OKD_DEV_ENDPOINT: https://okd-dev.hbp.eu:443
  OKD_PROD_ENDPOINT: https://okd.hbp.eu:443
  OKD_DEV_SECRET: ${{ secrets.OKD_DEV_SECRET }}
  OKD_PROD_SECRET: ${{ secrets.OKD_PROD_SECRET }}
  DOCKER_REGISTRY: 'docker-registry.ebrains.eu/siibra/'
  DOCKER_IMG: 'siibra-api'

jobs:
  build-docker-img:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: 'Set DOCKER_IMG_TAG'
      run: |
        echo "Event: $GITHUB_EVENT_NAME"

        if [ "$GITHUB_EVENT_NAME" = "push" ]
        then
          DOCKER_IMG_TAG=latest
        fi

        if [ "$GITHUB_EVENT_NAME" = "release" ]
        then

          # since it's release, set PROD_FLAG to true
          echo "PROD_FLAG=1" >> $GITHUB_ENV

          if [[ "$GITHUB_REF" = *"rc"* ]]
          then
            # if release contains rc, set img tag to rc
            DOCKER_IMG_TAG=rc
          else
            # if release contains rc, otherwise, set img tag to stable
            DOCKER_IMG_TAG=stable
          fi
        fi

        echo "DOCKER_IMG_TAG: $DOCKER_IMG_TAG"
        echo "DOCKER_IMG_TAG=$DOCKER_IMG_TAG" >> $GITHUB_ENV

    - name: 'Build docker image'
      run: |
        DOCKER_BUILT_TAG=${{ env.DOCKER_REGISTRY }}${{ env.DOCKER_IMG }}:$DOCKER_IMG_TAG
        echo "Building $DOCKER_BUILT_TAG"
        if [ -z "$PROD_FLAG" ]
        then
          echo "PROD_FLAG set, build for prod"
          docker build \
            --build-arg PROD_FLAG=1 \
            -t $DOCKER_BUILT_TAG \
            .
        else
          echo "PROD_FLAG not set, build latest"
          docker build \
            -t $DOCKER_BUILT_TAG \
            .
        fi
        echo "Successfully built $DOCKER_BUILT_TAG"
        echo "DOCKER_BUILT_TAG=$DOCKER_BUILT_TAG" >> $GITHUB_ENV

    - name: 'Push to docker registry'
      run: |
        echo "Login to docker registry"
        docker login \
          -u '${{ secrets.EBRAINS_DOCKER_REG_USER }}' \
          -p '${{ secrets.EBRAINS_DOCKER_REG_TOKEN }}' \
          docker-registry.ebrains.eu
        echo "Pushing $DOCKER_BUILT_TAG"
        docker push $DOCKER_BUILT_TAG
        

  deploy-on-okd:
    needs: build-docker-img
    if: success()
    runs-on: ubuntu-latest
    steps:

    - uses: actions/checkout@v2
    - name: 'Set env var'
      run: |
        echo "Event: $GITHUB_EVENT_NAME"

        if [ "$GITHUB_EVENT_NAME" = "push" ]
        then
          echo "event triggered is 'push', use develop envvar"
          OKD_ENDPOINT=${{ env.OKD_DEV_ENDPOINT }}
          OKD_SECRET=${{ env.OKD_DEV_SECRET }}
          DEPLOY_SITE_POSTFIX="-dev"

          DOCKER_IMG_TAG=latest
        fi

        if [ "$GITHUB_EVENT_NAME" = "release" ]
        then
          echo "event triggered is 'reelease', use prod envvar"
          # since it's release, set PROD_FLAG to true
          echo "PROD_FLAG=1" >> $GITHUB_ENV

          OKD_ENDPOINT=${{ env.OKD_PROD_ENDPOINT }}
          OKD_SECRET=${{ env.OKD_PROD_SECRET }}
          DEPLOY_SITE_POSTFIX=""

          if [[ "$GITHUB_REF" = *"rc"* ]]
          then
            # if release contains rc, set img tag to rc
            DOCKER_IMG_TAG=rc
          else
            # if release contains rc, otherwise, set img tag to stable
            DOCKER_IMG_TAG=stable
          fi
        fi

        echo "OKD_ENDPOINT=$OKD_ENDPOINT" >> $GITHUB_ENV
        echo "OKD_SECRET=$OKD_SECRET" >> $GITHUB_ENV
        echo "DEPLOY_SITE_POSTFIX=$DEPLOY_SITE_POSTFIX" >> $GITHUB_ENV

        echo "DOCKER_IMG_TAG: $DOCKER_IMG_TAG"
        echo "DOCKER_IMG_TAG=$DOCKER_IMG_TAG" >> $GITHUB_ENV

    - name: 'Login via oc cli & deploy'
      run: |
        oc login ${OKD_ENDPOINT} --token=${OKD_SECRET}
        oc project ${{ env.OKD_PROJECT }}

        # sanitise docker_img_tag, even though it shouldn't be necessary (valid tags are latest | rc | stable )
        DEPLOY_FLAVOUR=$(echo ${DOCKER_IMG_TAG//[_\/]/} | awk '{ print tolower($0) }')
        echo "Working docker tag: $DOCKER_IMG_TAG, sanitized flavour: $DEPLOY_FLAVOUR"
        
        # check if the deploy already exist
        if oc get dc siibra-api-branch-deploy-$DEPLOY_FLAVOUR; then
          # trigger redeploy if deployconfig exists already
          echo "dc siibra-api-branch-deploy-$DEPLOY_FLAVOUR already exist, redeploy..."
          oc rollout latest dc/siibra-api-branch-deploy-$DEPLOY_FLAVOUR
        else 
          # create new app if deployconfig does not yet exist
          echo "dc siibra-api-branch-deploy-$DEPLOY_FLAVOUR does not yet exist, create new app..."
          oc new-app --template siibra-api-branch-deploy \
            -p BRANCH_NAME=$BRANCH_NAME \
            -p DEPLOY_SITE_POSTFIX=$DEPLOY_SITE_POSTFIX \
            -p DEPLOY_FLAVOUR=$DEPLOY_FLAVOUR
        fi

  
      # - name: 'Update status badge'
      #   if: success()
      #   run: |
      #     curl -v \
      #       -X POST \
      #       -H "Authorization: Token ${{ secrets.WORKFLOW_TOKEN }}" \
      #       -H 'accept: application/vnd.github.v3+json' \
      #       ${GITHUB_API_ROOT}/statuses/${GITHUB_SHA} \
      #       -d '{
      #         "target_url":"https://siibra-api-${{ env.SANITIZED_BRANCH_NAME }}.apps-dev.hbp.eu/",
      #         "name": "Deployed at OKD",
      #         "state": "success"
      #       }'